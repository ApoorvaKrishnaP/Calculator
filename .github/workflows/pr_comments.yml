name: Log Review Comments

on:
  # This is the specific event for inline code comments on a PR
  pull_request_review_comment:
    types: [ created ] # Only log when a new comment is created
  
permissions:
  contents: write

jobs:
  log_comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Append Comment to Log File
        # This uses the 'jq' tool to safely append JSON data to a file.
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          # Define the data structure for the comment you want to save
          COMMENT_DATA='{
            "pr_number": ${{ github.event.pull_request.number }},
            "user": "${{ github.event.comment.user.login }}",
            "body": "${{ github.event.comment.body }}",
            "path": "${{ github.event.comment.path }}",
            "date": "'$TIMESTAMP'"
          }'
          
          # 1. Create the log file if it doesn't exist
          if [ ! -f review_logs.json ]; then
            echo '[]' > review_logs.json
          fi
          
          # 2. Append the new JSON comment data to the array in the file
          jq --argjson new_comment "$COMMENT_DATA" '. + [$new_comment]' review_logs.json > temp.json && mv temp.json review_logs.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-genai

      - name: Generate Rules from Comments
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python ai_reviewer/generate_rules.py

      - name: Commit Log File and Rules
        # Use a special action to commit the changes back to the repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'Auto-logging new PR review comment and updating rules'
          file_pattern: 'review_logs.json ai_reviewer/project_rules.md'
          branch: 'main'
