name: Log Review Comments

on:
  # This is the specific event for inline code comments on a PR
  pull_request_review_comment:
    types: [ created ] # Only log when a new comment is created
  
permissions:
  contents: write

jobs:
  log_comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Append Comment to Log File
        # This uses the 'jq' tool to safely append JSON data to a file.
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          # Define the data structure for the comment you want to save
          COMMENT_DATA='{
            "pr_number": ${{ github.event.pull_request.number }},
            "user": "${{ github.event.comment.user.login }}",
            "body": "${{ github.event.comment.body }}",
            "path": "${{ github.event.comment.path }}",
            "date": "'$TIMESTAMP'"
          }'
          
          # 1. Create the log file if it doesn't exist
          if [ ! -f review_log.json ]; then
            echo '[]' > review_log.json
          fi
          
          # 2. Append the new JSON comment data to the array in the file
          jq --argjson new_comment "$COMMENT_DATA" '. + [$new_comment]' review_log.json > temp.json && mv temp.json review_log.json

      - name: Commit Log File
        # Use a special action to commit the changes back to the repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'Auto-logging new PR review comment'
          file_pattern: 'review_log.json'
          branch: 'main'
